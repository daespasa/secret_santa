<!DOCTYPE html>
<html lang="es" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Amigo Invisible</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192.png" />
    <meta name="theme-color" content="#ef4444" />
    <meta
      name="description"
      content="Gestiona tus grupos de amigo invisible, revisa participantes y controla el estado de los sorteos."
    />
    <link rel="preload" href="/style.css" as="style" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;700&display=swap"
    />
  </head>
  <body class="h-full flex flex-col">
    <%- include('./partials/header') %>

    <div class="flex-1 flex flex-col bg-gray-100 pt-16">
      <!-- Flash Messages -->
      <% if (flash && (flash.error || flash.success || flash.info)) { %>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        <% if (flash.error) { %> <% flash.error.forEach(msg => { %>
        <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-4 rounded">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg
                class="h-5 w-5 text-red-400"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm text-red-800"><%= msg %></p>
            </div>
          </div>
        </div>
        <% }) %> <% } %> <% if (flash.success) { %> <%
        flash.success.forEach((msg) => { %>
        <div class="bg-green-50 border-l-4 border-green-400 p-4 mb-4 rounded">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg
                class="h-5 w-5 text-green-400"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm text-green-800"><%= msg %></p>
            </div>
          </div>
        </div>
        <% }) %> <% } %> <% if (flash.info) { %> <% flash.info.forEach((msg) =>
        { %>
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg
                class="h-5 w-5 text-blue-400"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                  clip-rule="evenodd"
                />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm text-blue-800"><%= msg %></p>
            </div>
          </div>
        </div>
        <% }) %> <% } %>
      </div>
      <% } %>

      <main class="px-4 sm:px-6 lg:px-8 py-8 sm:py-10">
        <div class="max-w-7xl mx-auto">
          <!-- Stats Cards -->
          <div
            class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-8"
          >
            <!-- Total Grupos -->
            <div
              class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition"
            >
              <div class="p-6">
                <div class="flex items-center">
                  <div class="flex-shrink-0">
                    <div class="text-red-600">
                      <%- renderIcon("groups", "text-4xl") %>
                    </div>
                  </div>
                  <div class="ml-5 w-0 flex-1">
                    <dl>
                      <dt class="text-sm font-medium text-gray-500 truncate">
                        Total Grupos
                      </dt>
                      <dd class="text-3xl font-semibold text-gray-900">
                        <%= stats.totalGroups %>
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <!-- Administrados -->
            <div
              class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition"
            >
              <div class="p-6">
                <div class="flex items-center">
                  <div class="flex-shrink-0">
                    <div class="text-yellow-500">
                      <%- renderIcon("crown", "text-4xl") %>
                    </div>
                  </div>
                  <div class="ml-5 w-0 flex-1">
                    <dl>
                      <dt class="text-sm font-medium text-gray-500 truncate">
                        Administrados
                      </dt>
                      <dd class="text-3xl font-semibold text-gray-900">
                        <%= stats.adminGroups %>
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <!-- Sorteados -->
            <div
              class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition"
            >
              <div class="p-6">
                <div class="flex items-center">
                  <div class="flex-shrink-0">
                    <div class="text-green-600">
                      <%- renderIcon("check_circle", "text-4xl") %>
                    </div>
                  </div>
                  <div class="ml-5 w-0 flex-1">
                    <dl>
                      <dt class="text-sm font-medium text-gray-500 truncate">
                        Sorteados
                      </dt>
                      <dd class="text-3xl font-semibold text-green-600">
                        <%= stats.drawnGroups %>
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>

            <!-- Pendientes -->
            <div
              class="bg-white overflow-hidden shadow rounded-lg hover:shadow-lg transition"
            >
              <div class="p-6">
                <div class="flex items-center">
                  <div class="flex-shrink-0">
                    <div class="text-orange-600">
                      <%- renderIcon("schedule", "text-4xl") %>
                    </div>
                  </div>
                  <div class="ml-5 w-0 flex-1">
                    <dl>
                      <dt class="text-sm font-medium text-gray-500 truncate">
                        Pendientes
                      </dt>
                      <dd class="text-3xl font-semibold text-orange-600">
                        <%= stats.pendingGroups %>
                      </dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Button -->
          <div class="mb-8">
            <a
              href="/groups/new"
              class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
            >
              <%- renderIcon("add_circle", "text-lg mr-2") %> Crear Nuevo Grupo
            </a>
          </div>

          <!-- Groups List with Filters -->
          <div class="bg-white shadow overflow-hidden sm:rounded-md">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
              <div
                class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
              >
                <div>
                  <h3 class="text-lg leading-6 font-medium text-gray-900">
                    Mis Grupos
                  </h3>
                  <p class="mt-1 text-sm text-gray-500">
                    Grupos donde participas o administras
                  </p>
                </div>
              </div>

              <!-- Filters and Search -->
              <div class="mt-4 flex flex-col sm:flex-row gap-3">
                <!-- Search Input -->
                <div class="flex-1">
                  <input
                    type="text"
                    id="searchGroups"
                    placeholder="Buscar grupos..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-md text-sm focus:ring-red-500 focus:border-red-500"
                  />
                </div>

                <!-- Filter Buttons -->
                <div class="flex gap-2 flex-wrap">
                  <button
                    class="filter-btn active px-4 py-2 text-sm font-medium rounded-md border-2 border-red-600 text-red-600 bg-white hover:bg-red-50 transition"
                    data-filter="all"
                  >
                    Todos
                  </button>
                  <button
                    class="filter-btn px-4 py-2 text-sm font-medium rounded-md border-2 border-gray-300 text-gray-700 bg-white hover:border-green-600 hover:text-green-600 transition"
                    data-filter="drawn"
                  >
                    <%- renderIcon("check_circle", "text-base") %> Sorteados
                  </button>
                  <button
                    class="filter-btn px-4 py-2 text-sm font-medium rounded-md border-2 border-gray-300 text-gray-700 bg-white hover:border-orange-600 hover:text-orange-600 transition"
                    data-filter="pending"
                  >
                    <%- renderIcon("schedule", "text-base") %> Pendientes
                  </button>
                  <button
                    class="filter-btn px-4 py-2 text-sm font-medium rounded-md border-2 border-gray-300 text-gray-700 bg-white hover:border-yellow-600 hover:text-yellow-600 transition"
                    data-filter="admin"
                  >
                    <%- renderIcon("crown", "text-base") %> Administrados
                  </button>
                </div>
              </div>
            </div>

            <% if (!groups.length) { %>
            <div class="text-center py-12">
              <%- renderIcon("groups", "text-9xl text-gray-300") %>
              <h3 class="mt-4 text-lg font-medium text-gray-900">
                No hay grupos
              </h3>
              <p class="mt-2 text-sm text-gray-500">
                Comienza creando un nuevo grupo o únete con un enlace de
                invitación.
              </p>
              <div class="mt-6">
                <a
                  href="/groups/new"
                  class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700"
                >
                  <%- renderIcon("add_circle", "text-base mr-1.5") %> Crear
                  Grupo
                </a>
              </div>
            </div>
            <% } else { %>
            <div id="groupsContainer">
              <ul class="divide-y divide-gray-200">
                <% groups.forEach((g) => { %>
                <li
                  class="group-item"
                  data-status="<%= g.drawn ? 'drawn' : 'pending' %>"
                  data-is-admin="<%= g.isAdmin ? 'true' : 'false' %>"
                  data-name="<%= g.name.toLowerCase() %>"
                >
                  <div class="px-4 py-5 sm:px-6 hover:bg-gray-50 transition">
                    <!-- Nombre del grupo y estado -->
                    <div class="flex items-start justify-between mb-4">
                      <div class="flex items-center min-w-0 flex-1">
                        <span
                          class="flex-shrink-0 mr-3 text-2xl"
                          style="color: <%= g.color || '#DC2626' %>"
                        >
                          <%- renderGroupIcon(g.icon, "text-2xl") %>
                        </span>
                        <div class="min-w-0 flex-1">
                          <h4
                            class="text-lg font-semibold text-gray-900 truncate group-name"
                          >
                            <a
                              href="/groups/<%= g.id %>"
                              class="hover:text-red-600 hover:underline"
                            >
                              <%= g.name %>
                            </a>
                          </h4>
                        </div>
                      </div>
                      <div class="flex-shrink-0 ml-4 flex gap-2">
                        <% if (g.drawn) { %>
                        <span
                          class="px-3 py-1 inline-flex items-center text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 whitespace-nowrap"
                        >
                          <%- renderIcon("check_circle", "text-xs mr-1") %>
                          Sorteado
                        </span>
                        <% } else { %>
                        <span
                          class="px-3 py-1 inline-flex items-center text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800 whitespace-nowrap"
                        >
                          <%- renderIcon("schedule", "text-xs mr-1") %>
                          Pendiente
                        </span>
                        <% } %>
                      </div>
                    </div>

                    <!-- Información del grupo -->
                    <div
                      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
                    >
                      <!-- Participantes y rol -->
                      <div
                        class="flex items-center text-sm text-gray-600 space-x-4"
                      >
                        <div class="flex items-center">
                          <%- renderIcon("people", "text-lg text-gray-400mr-1.5") %>
                          <span
                            ><%= g.participantCount %> participante<%=
                            g.participantCount !== 1 ? 's' : '' %></span
                          >
                        </div>
                        <% if (g.isAdmin) { %>
                        <div
                          class="flex items-center px-2 py-1 bg-yellow-50 rounded"
                        >
                          <%- renderIcon("star", "text-lg text-yellow-500 mr-1")
                          %>
                          <span class="font-medium text-yellow-700">Admin</span>
                        </div>
                        <% } %>
                      </div>

                      <!-- Acciones -->
                      <div class="flex items-center gap-2 flex-wrap">
                        <!-- Copy Invitation Link Button -->
                        <button
                          type="button"
                          class="copy-invite-btn inline-flex items-center gap-1.5 px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition"
                          data-group-id="<%= g.id %>"
                          data-invitation-code="<%= g.invitationCode %>"
                          title="Copiar enlace de invitación"
                        >
                          <%- renderIcon("link", "text-base") %>
                          <span class="hidden sm:inline">Copiar</span>
                        </button>

                        <!-- Share Invitation Link Button -->
                        <div class="share-btn-container">
                          <button
                            type="button"
                            class="share-btn inline-flex items-center gap-1.5 px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition"
                            data-group-id="<%= g.id %>"
                            data-invitation-code="<%= g.invitationCode %>"
                            title="Compartir"
                          >
                            <%- renderIcon("share", "text-base") %>
                            <span class="hidden sm:inline">Compartir</span>
                          </button>
                        </div>

                        <% if (g.isAdmin && !g.drawn) { %>
                        <form
                          method="post"
                          action="/groups/<%= g.id %>/draw"
                          class="inline"
                        >
                          <input
                            type="hidden"
                            name="_csrf"
                            value="<%= csrfToken %>"
                          />
                          <button
                            type="submit"
                            class="inline-flex items-center gap-1.5 px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition"
                          >
                            <%- renderIcon("dice", "text-base") %>
                            <span class="hidden sm:inline">Sortear</span>
                          </button>
                        </form>
                        <% } %>
                        <a
                          href="/groups/<%= g.id %>"
                          class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition"
                        >
                          <%- renderIcon("arrow_forward", "text-base") %>
                          <span class="hidden sm:inline">Ver</span>
                        </a>
                      </div>
                    </div>
                  </div>
                </li>
                <% }) %>
              </ul>
            </div>

            <!-- Empty state for filters -->
            <div id="emptyFiltered" class="hidden text-center py-12">
              <%- renderIcon("search", "text-9xl text-gray-300") %>
              <h3 class="mt-4 text-lg font-medium text-gray-900">
                No se encontraron grupos
              </h3>
              <p class="mt-2 text-sm text-gray-500">
                Intenta con otros filtros o criterios de búsqueda.
              </p>
            </div>
            <% } %>
          </div>
        </div>
      </main>
    </div>
    <%- include('./partials/footer') %>

    <script>
      // Filter and Search Functionality
      const searchInput = document.getElementById("searchGroups");
      const filterBtns = document.querySelectorAll(".filter-btn");
      const groupItems = document.querySelectorAll(".group-item");
      const groupsContainer = document.getElementById("groupsContainer");
      const emptyFiltered = document.getElementById("emptyFiltered");
      const copyInviteBtns = document.querySelectorAll(".copy-invite-btn");

      let currentFilter = "all";

      // Update display based on search and filter
      function updateDisplay() {
        const searchTerm = searchInput.value.toLowerCase();
        let visibleCount = 0;

        groupItems.forEach((item) => {
          const groupName = item
            .getAttribute("data-name")
            .toLowerCase()
            .includes(searchTerm);
          const status = item.getAttribute("data-status");
          const isAdmin = item.getAttribute("data-is-admin") === "true";

          let showByFilter = false;
          if (currentFilter === "all") {
            showByFilter = true;
          } else if (currentFilter === "drawn" && status === "drawn") {
            showByFilter = true;
          } else if (currentFilter === "pending" && status === "pending") {
            showByFilter = true;
          } else if (currentFilter === "admin" && isAdmin) {
            showByFilter = true;
          }

          const shouldShow = groupName && showByFilter;
          item.style.display = shouldShow ? "" : "none";
          if (shouldShow) visibleCount++;
        });

        // Show empty state if no groups match
        if (visibleCount === 0 && groupItems.length > 0) {
          groupsContainer.style.display = "none";
          emptyFiltered.style.display = "block";
        } else {
          groupsContainer.style.display = "block";
          emptyFiltered.style.display = "none";
        }
      }

      // Search input event
      searchInput.addEventListener("input", updateDisplay);

      // Filter button events
      filterBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          filterBtns.forEach((b) => {
            b.classList.remove("border-red-600", "text-red-600", "bg-white");
            b.classList.add("border-gray-300", "text-gray-700");
          });

          btn.classList.add("border-red-600", "text-red-600", "bg-white");
          btn.classList.remove("border-gray-300", "text-gray-700");

          currentFilter = btn.getAttribute("data-filter");
          updateDisplay();
        });
      });

      // Copy invitation link functionality
      copyInviteBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
          const groupId = btn.getAttribute("data-group-id");
          const invitationCode = btn.getAttribute("data-invitation-code");
          const baseUrl = window.location.origin;
          const invitationUrl = `${baseUrl}/join/${invitationCode}`;

          try {
            await navigator.clipboard.writeText(invitationUrl);

            // Show feedback
            const originalText = btn.innerHTML;
            btn.innerHTML =
              '<%- renderIcon("check_circle", "text-base") %> <span class="hidden sm:inline">¡Copiado!</span>';
            btn.classList.add("bg-green-50", "text-green-700");

            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.classList.remove("bg-green-50", "text-green-700");
            }, 2000);
          } catch (err) {
            console.error("Error copying to clipboard:", err);
            alert("Error al copiar el enlace");
          }
        });
      });

      // Share functionality with fixed positioning dropdown
      let globalShareMenu = document.getElementById(
        "global-share-dropdown-menu"
      );
      if (!globalShareMenu) {
        globalShareMenu = document.createElement("div");
        globalShareMenu.id = "global-share-dropdown-menu";
        globalShareMenu.className =
          "fixed bg-white rounded-md shadow-lg opacity-0 invisible transition-opacity duration-200 z-50 w-40";
        globalShareMenu.style.pointerEvents = "none";
        document.body.appendChild(globalShareMenu);
      }

      const shareButtons = document.querySelectorAll(".share-btn");
      shareButtons.forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const rect = btn.getBoundingClientRect();
          const groupId = btn.getAttribute("data-group-id");
          const invitationCode = btn.getAttribute("data-invitation-code");

          // Build share menu HTML
          const baseUrl = window.location.origin;
          const invitationUrl = `${baseUrl}/join/${invitationCode}`;
          const message = `¡Únete a nuestro Amigo Invisible! ${invitationUrl}`;

          globalShareMenu.innerHTML = `
            <a href="#" class="dashboard-share-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-platform="whatsapp">
              <%- renderIcon("whatsapp", "text-base mr-1.5") %>
              WhatsApp
            </a>
            <a href="#" class="dashboard-share-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-platform="telegram">
              <%- renderIcon("telegram", "text-base mr-1.5") %>
              Telegram
            </a>
            <a href="#" class="dashboard-share-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-platform="twitter">
              <%- renderIcon("twitter", "text-base mr-1.5") %>
              Twitter
            </a>
            <a href="#" class="dashboard-share-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-platform="email">
              <%- renderIcon("email_icon", "text-base mr-1.5") %>
              Email
            </a>
          `;

          // Position menu
          globalShareMenu.style.top = rect.bottom + 8 + "px";
          globalShareMenu.style.left = rect.left + "px";
          globalShareMenu.style.pointerEvents = "auto";
          globalShareMenu.classList.remove("opacity-0", "invisible");
          globalShareMenu.classList.add("opacity-100", "visible");

          // Add click handlers to share links
          const shareLinks = globalShareMenu.querySelectorAll(
            ".dashboard-share-link"
          );
          shareLinks.forEach((link) => {
            link.addEventListener("click", (e) => {
              e.preventDefault();
              const platform = link.getAttribute("data-platform");

              let shareUrl;
              switch (platform) {
                case "whatsapp":
                  shareUrl = `https://wa.me/?text=${encodeURIComponent(
                    message
                  )}`;
                  break;
                case "telegram":
                  shareUrl = `https://t.me/share/url?url=${encodeURIComponent(
                    invitationUrl
                  )}&text=${encodeURIComponent(
                    "¡Únete a nuestro Amigo Invisible!"
                  )}`;
                  break;
                case "twitter":
                  shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(
                    "¡Únete a nuestro Amigo Invisible! " + invitationUrl
                  )}`;
                  break;
                case "email":
                  shareUrl = `mailto:?subject=${encodeURIComponent(
                    "¡Únete a nuestro Amigo Invisible!"
                  )}&body=${encodeURIComponent(message)}`;
                  break;
              }

              if (shareUrl) {
                window.open(shareUrl, "_blank");
              }

              // Close menu
              globalShareMenu.classList.add("opacity-0", "invisible");
              globalShareMenu.style.pointerEvents = "none";
            });
          });
        });
      });

      // Close menu on outside click
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".share-btn-container")) {
          globalShareMenu.classList.add("opacity-0", "invisible");
          globalShareMenu.style.pointerEvents = "none";
        }
      });
    </script>
  </body>
</html>
