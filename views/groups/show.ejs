<!DOCTYPE html>
<html lang="es" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= group.name %></title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192.png" />
    <meta name="theme-color" content="#ef4444" />
    <meta
      name="description"
      content="Detalles del grupo <%= group.name %>: participantes, invitación y estado del sorteo de amigo invisible."
    />
    <link rel="preload" href="/style.css" as="style" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;700&display=swap"
    />
  </head>
  <body class="h-full flex flex-col bg-gray-50">
    <%- include('../partials/header') %>

    <main class="flex-1 max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10 w-full pt-16">
      <%- include('../partials/flash') %>

      <header class="bg-white shadow rounded-lg p-4 sm:p-6 mb-6">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
          <div class="flex items-start gap-3 flex-1">
            <span class="flex-shrink-0 text-3xl sm:text-4xl" style="color: <%= group.color || '#DC2626' %>"
              ><%- renderGroupIcon(group.icon, "text-3xl sm:text-4xl") %></span
            >
            <div class="min-w-0 flex-1">
              <h2 class="text-xl sm:text-2xl font-bold text-gray-900 break-words">
                <%= group.name %>
              </h2>
              <% if (group.description) { %>
              <p class="text-gray-600 mt-1 text-sm sm:text-base break-words"><%= group.description %></p>
              <% } %>
              <p class="mt-2 text-sm">
                Estado: <% if (group.drawnAt) { %>
                <span
                  class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-800"
                  ><%- renderIcon("check_circle", "text-xs mr-1") %>Sorteado</span
                >
                <% } else { %>
                <span
                  class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-orange-100 text-orange-800"
                  ><%- renderIcon("schedule", "text-xs mr-1") %>Pendiente</span
                >
                <% } %>
              </p>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
            <% if (!group.drawnAt && group.adminUserId === currentUser.id) { %>
            <form method="post" action="/groups/<%= group.id %>/draw" class="w-full sm:w-auto">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <button
                type="submit"
                class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 whitespace-nowrap transition text-sm sm:text-base"
              >
                <%- renderIcon("dice", "text-base") %> Iniciar sorteo
              </button>
            </form>
            <% } %>
            
            <% if (group.adminUserId === currentUser.id) { %>
            <a
              href="/groups/<%= group.id %>/edit"
              class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 whitespace-nowrap transition text-sm sm:text-base"
            >
              <%- renderIcon("edit", "text-base") %> Editar
            </a>
            <% } %>

            <% if (group.adminUserId === currentUser.id) { %>
            <button
              type="button"
              class="inline-flex items-center justify-center gap-2 px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 whitespace-nowrap transition text-sm sm:text-base toggle-delete-modal"
            >
              <%- renderIcon("delete", "text-base") %> Eliminar
            </button>
            <% } else { %>
            <form method="post" action="/groups/<%= group.id %>/leave" class="w-full sm:w-auto">
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <button
                type="submit"
                class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 rounded-md bg-orange-600 text-white hover:bg-orange-700 whitespace-nowrap transition text-sm sm:text-base"
                onclick="return confirm('¿Estás seguro de que quieres dejar este grupo?')"
              >
                <%- renderIcon("logout", "text-base") %> Dejar grupo
              </button>
            </form>
            <% } %>
          </div>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <section class="bg-white shadow rounded-lg p-4 sm:p-6 lg:col-span-2">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <%- renderIcon("info", "text-xl") %> Detalles
          </h3>
          <dl class="divide-y divide-gray-200">
            <% if (group.priceMax) { %>
            <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500">Precio máximo</dt>
              <dd class="text-sm text-gray-900 sm:col-span-2">
                <%= group.priceMax %>
              </dd>
            </div>
            <% } %> <% if (group.eventDate) { %>
            <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500">Evento</dt>
              <dd class="text-sm text-gray-900 sm:col-span-2">
                <%= dayjs(group.eventDate).format('YYYY-MM-DD') %>
              </dd>
            </div>
            <% } %> <% if (group.drawDeadline) { %>
            <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500">
                Límite inscripción
              </dt>
              <dd class="text-sm text-gray-900 sm:col-span-2">
                <%= dayjs(group.drawDeadline).format('YYYY-MM-DD') %>
              </dd>
            </div>
            <% } %> <% if (group.rules) { %>
            <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500">Reglas</dt>
              <dd
                class="text-sm text-gray-900 sm:col-span-2 whitespace-pre-line break-words"
              >
                <%= group.rules %>
              </dd>
            </div>
            <% } %>
            <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500">Invitación</dt>
              <dd class="text-sm text-gray-900 sm:col-span-2">
                <div class="bg-gray-100 rounded px-3 py-2 break-all text-xs sm:text-sm mb-2">
                  <%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>
                </div>
                <div class="flex flex-col sm:flex-row gap-2">
                  <a
                    class="inline-flex items-center justify-center sm:justify-start gap-1 text-blue-600 hover:bg-blue-50 text-sm px-3 py-2 rounded border border-blue-200 hover:underline transition"
                    href="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"
                    ><%- renderIcon("open_in_new", "text-sm") %> Abrir</a>
                  <button
                    type="button"
                    class="copy-group-link inline-flex items-center justify-center sm:justify-start gap-1 text-gray-700 hover:bg-gray-200 text-sm px-3 py-2 rounded border border-gray-300 transition"
                    data-invite-link="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"
                    >
                    <%- renderIcon("link", "text-sm") %> Copiar
                  </button>
                  <div class="relative inline-block share-dropdown-container">
                    <button
                      type="button"
                      class="share-group-btn inline-flex items-center justify-center sm:justify-start gap-1 text-gray-700 hover:bg-gray-200 text-sm px-3 py-2 rounded border border-gray-300 transition"
                      data-group-name="<%= group.name %>"
                      data-invite-link="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"
                      >
                      <%- renderIcon("share", "text-sm") %> Compartir
                    </button>
                    <!-- Share Menu -->
                    <div class="share-dropdown-menu absolute left-0 mt-2 w-40 bg-white rounded-md shadow-lg opacity-0 invisible transition-opacity duration-200 z-20">
                      <a href="#" class="share-group-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-md first:rounded-t-md last:rounded-b-md" data-platform="whatsapp" data-group-name="<%= group.name %>" data-invite-link="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"><%- renderIcon("whatsapp", "text-base mr-1.5") %>WhatsApp</a>
                      <a href="#" class="share-group-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 first:rounded-t-md last:rounded-b-md" data-platform="telegram" data-group-name="<%= group.name %>" data-invite-link="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"><%- renderIcon("telegram", "text-base mr-1.5") %>Telegram</a>
                      <a href="#" class="share-group-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 first:rounded-t-md last:rounded-b-md" data-platform="twitter" data-group-name="<%= group.name %>" data-invite-link="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"><%- renderIcon("twitter", "text-base mr-1.5") %>Twitter</a>
                      <a href="#" class="share-group-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 first:rounded-t-md last:rounded-b-md" data-platform="email" data-group-name="<%= group.name %>" data-invite-link="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"><%- renderIcon("email_icon", "text-base mr-1.5") %>Email</a>
                    </div>
                  </div>
                </div>
              </dd>
            </div>
          </dl>
        </section>

        <section class="bg-white shadow rounded-lg p-4 sm:p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <%- renderIcon("people", "text-xl") %> Participantes (<%= participants.length %>)
          </h3>
          <ul class="space-y-2 sm:space-y-3 text-gray-800">
            <% participants.forEach(p => { %>
            <li class="flex items-center gap-2 sm:gap-3">
              <div class="flex-shrink-0">
                <% if (p.user.profilePhoto) { %>
                <img
                  src="<%= p.user.profilePhoto %>"
                  alt="<%= p.user.name %>"
                  class="h-8 w-8 sm:h-10 sm:w-10 rounded-full object-cover border border-gray-300"
                />
                <% } else { %>
                <div
                  class="h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-gradient-to-br from-gray-400 to-gray-600 flex items-center justify-center text-white text-xs sm:text-sm font-semibold"
                >
                  <%= p.user.name.charAt(0).toUpperCase() %>
                </div>
                <% } %>
              </div>
              <span class="font-medium text-sm sm:text-base truncate"><%= p.user.name %></span>
            </li>
            <% }) %>
          </ul>
        </section>
      </div>

      <section class="bg-white shadow rounded-lg p-4 sm:p-6 mt-6">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <%- renderIcon("card_giftcard", "text-xl") %> Tu resultado
        </h3>
        <% if (group.drawnAt && receiver) { %>
        <div
          class="flex items-center gap-3 sm:gap-4 p-4 bg-red-50 rounded-lg border border-red-200"
        >
          <div class="flex-shrink-0">
            <% if (receiver.profilePhoto) { %>
            <img
              src="<%= receiver.profilePhoto %>"
              alt="<%= receiver.name %>"
              class="h-12 w-12 sm:h-16 sm:w-16 rounded-full object-cover border-2 border-red-300"
            />
            <% } else { %>
            <div
              class="h-12 w-12 sm:h-16 sm:w-16 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white text-lg sm:text-xl font-semibold"
            >
              <%= receiver.name.charAt(0).toUpperCase() %>
            </div>
            <% } %>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs sm:text-sm text-gray-600 mb-1">Tu amigo invisible es:</p>
            <p class="text-xl sm:text-2xl font-bold text-red-600 break-words"><%= receiver.name %></p>
          </div>
        </div>
        <% } else if (!group.drawnAt) { %>
        <p class="text-gray-600 text-sm sm:text-base">Aún no se ha realizado el sorteo.</p>
        <% } else { %>
        <p class="text-gray-600 text-sm sm:text-base">No se encontró asignación.</p>
        <% } %>
      </section>
    </main>
    <%- include('../partials/footer') %>

    <!-- Delete Group Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-lg max-w-sm w-full p-6 shadow-xl">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
          <%- renderIcon("warning", "text-2xl text-red-600") %> Eliminar grupo
        </h3>
        <p class="text-gray-600 mb-6">¿Qué deseas hacer con este grupo?</p>
        
        <div class="space-y-3 mb-6">
          <p class="text-sm text-gray-500">
            <strong>Archivar:</strong> El grupo se ocultará pero los datos se conservarán.
          </p>
          <p class="text-sm text-gray-500">
            <strong>Eliminar:</strong> El grupo y todos sus datos se eliminarán permanentemente.
          </p>
        </div>

        <form method="post" action="/groups/<%= group.id %>/delete" id="deleteForm" class="flex flex-col sm:flex-row gap-3">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <input type="hidden" name="action" id="actionInput" value="" />
          
          <button
            type="button"
            class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 transition cancel-delete-modal text-sm"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="flex-1 px-4 py-2 rounded-md bg-yellow-600 text-white hover:bg-yellow-700 transition text-sm archive-btn"
          >
            <%- renderIcon("archive", "text-base mr-1") %> Archivar
          </button>
          <button
            type="button"
            class="flex-1 px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 transition text-sm delete-btn"
          >
            <%- renderIcon("delete_forever", "text-base mr-1") %> Eliminar
          </button>
        </form>
      </div>
    </div>

    <script>
      // Delete modal
      const deleteModal = document.getElementById("deleteModal");
      const toggleDeleteBtn = document.querySelector(".toggle-delete-modal");
      const cancelDeleteBtn = document.querySelector(".cancel-delete-modal");

      if (toggleDeleteBtn) {
        toggleDeleteBtn.addEventListener("click", () => {
          deleteModal.classList.remove("hidden");
        });
      }

      if (cancelDeleteBtn) {
        cancelDeleteBtn.addEventListener("click", () => {
          deleteModal.classList.add("hidden");
        });
      }

      // Close modal when clicking outside
      deleteModal.addEventListener("click", (e) => {
        if (e.target === deleteModal) {
          deleteModal.classList.add("hidden");
        }
      });

      // Archive button handler
      const archiveBtn = document.querySelector(".archive-btn");
      if (archiveBtn) {
        archiveBtn.addEventListener("click", () => {
          document.getElementById("actionInput").value = "archive";
          document.getElementById("deleteForm").submit();
        });
      }

      // Delete button handler
      const deleteBtn = document.querySelector(".delete-btn");
      if (deleteBtn) {
        deleteBtn.addEventListener("click", () => {
          if (confirm("⚠️ Esta acción es irreversible. ¿Estás completamente seguro?")) {
            document.getElementById("actionInput").value = "delete";
            document.getElementById("deleteForm").submit();
          }
        });
      }

      // Share dropdown functionality
      const shareDropdownContainers = document.querySelectorAll(".share-dropdown-container");
      shareDropdownContainers.forEach((container) => {
        const btn = container.querySelector(".share-group-btn");
        const menu = container.querySelector(".share-dropdown-menu");

        if (btn && menu) {
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            // Toggle menu visibility
            const isHidden = menu.classList.contains("opacity-0");
            if (isHidden) {
              menu.classList.remove("opacity-0", "invisible");
              menu.classList.add("opacity-100", "visible");
            } else {
              menu.classList.add("opacity-0", "invisible");
              menu.classList.remove("opacity-100", "visible");
            }
          });

          // Close menu when clicking outside
          document.addEventListener("click", (e) => {
            if (!container.contains(e.target)) {
              menu.classList.add("opacity-0", "invisible");
              menu.classList.remove("opacity-100", "visible");
            }
          });

          // Close menu when clicking on a link
          menu.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", () => {
              menu.classList.add("opacity-0", "invisible");
              menu.classList.remove("opacity-100", "visible");
            });
          });
        }
      });

      // Copy group link functionality
      const copyGroupLinkBtns = document.querySelectorAll(".copy-group-link");
      copyGroupLinkBtns.forEach((btn) => {
        btn.addEventListener("click", async () => {
          const inviteLink = btn.getAttribute("data-invite-link");

          try {
            await navigator.clipboard.writeText(inviteLink);

            // Show feedback
            const originalText = btn.innerHTML;
            btn.innerHTML =
              '<%- renderIcon("check_circle", "text-sm") %> <span>¡Copiado!</span>';
            btn.classList.add("bg-green-50", "text-green-700");

            setTimeout(() => {
              btn.innerHTML = originalText;
              btn.classList.remove("bg-green-50", "text-green-700");
            }, 2000);
          } catch (err) {
            console.error("Error copying to clipboard:", err);
            alert("Error al copiar el enlace");
          }
        });
      });

      // Share group functionality
      const shareGroupLinks = document.querySelectorAll(".share-group-link");
      shareGroupLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          const platform = link.getAttribute("data-platform");
          const groupName = link.getAttribute("data-group-name");
          const inviteLink = link.getAttribute("data-invite-link");
          const message = `¡Únete a nuestro grupo "${groupName}" en Amigo Invisible! ${inviteLink}`;

          let shareUrl;
          switch (platform) {
            case "whatsapp":
              shareUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
              break;
            case "telegram":
              shareUrl = `https://t.me/share/url?url=${encodeURIComponent(inviteLink)}&text=${encodeURIComponent(`¡Únete a nuestro grupo "${groupName}" en Amigo Invisible!`)}`;
              break;
            case "twitter":
              shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(`¡Únete a "${groupName}" en Amigo Invisible! ${inviteLink}`)}`;
              break;
            case "email":
              shareUrl = `mailto:?subject=${encodeURIComponent(`Únete a ${groupName} en Amigo Invisible`)}&body=${encodeURIComponent(message)}`;
              break;
          }

          if (shareUrl) {
            window.open(shareUrl, "_blank");
          }
        });
      });
    </script>
  </body>
</html>
