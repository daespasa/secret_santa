<!DOCTYPE html>
<html lang="es" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= group.name %></title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192.png" />
    <meta name="theme-color" content="#ef4444" />
    <meta
      name="description"
      content="Detalles del grupo <%= group.name %>: participantes, invitación y estado del sorteo de amigo invisible."
    />
    <link rel="preload" href="/style.css" as="style" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="/style.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;700&display=swap"
    />
  </head>
  <body class="h-full flex flex-col bg-gray-50">
    <%- include('../partials/header') %>

    <main class="flex-1 max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10 w-full pt-16">
      <%- include('../partials/flash') %>

      <header class="bg-white shadow rounded-lg p-4 sm:p-6 mb-6">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
          <div class="flex items-start gap-3">
            <span class="flex-shrink-0 text-3xl sm:text-4xl" style="color: <%= group.color || '#DC2626' %>"
              ><%- renderGroupIcon(group.icon, "text-3xl sm:text-4xl") %></span
            >
            <div class="min-w-0 flex-1">
              <h2 class="text-xl sm:text-2xl font-bold text-gray-900 break-words">
                <%= group.name %>
              </h2>
              <% if (group.description) { %>
              <p class="text-gray-600 mt-1 text-sm sm:text-base break-words"><%= group.description %></p>
              <% } %>
              <p class="mt-2 text-sm">
                Estado: <% if (group.drawnAt) { %>
                <span
                  class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-800"
                  ><%- renderIcon("check_circle", "text-xs mr-1") %>Sorteado</span
                >
                <% } else { %>
                <span
                  class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-orange-100 text-orange-800"
                  ><%- renderIcon("schedule", "text-xs mr-1") %>Pendiente</span
                >
                <% } %>
              </p>
            </div>
          </div>
          <% if (!group.drawnAt && group.adminUserId === currentUser.id) { %>
          <form method="post" action="/groups/<%= group.id %>/draw" class="w-full sm:w-auto">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
            <button
              type="submit"
              class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 whitespace-nowrap"
            >
              <%- renderIcon("dice", "text-base") %> Iniciar sorteo
            </button>
          </form>
          <% } %>
        </div>
      </header>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <section class="bg-white shadow rounded-lg p-4 sm:p-6 lg:col-span-2">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <%- renderIcon("info", "text-xl") %> Detalles
          </h3>
          <dl class="divide-y divide-gray-200">
            <% if (group.priceMax) { %>
            <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500">Precio máximo</dt>
              <dd class="text-sm text-gray-900 sm:col-span-2">
                <%= group.priceMax %>
              </dd>
            </div>
            <% } %> <% if (group.eventDate) { %>
            <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500">Evento</dt>
              <dd class="text-sm text-gray-900 sm:col-span-2">
                <%= dayjs(group.eventDate).format('YYYY-MM-DD') %>
              </dd>
            </div>
            <% } %> <% if (group.drawDeadline) { %>
            <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500">
                Límite inscripción
              </dt>
              <dd class="text-sm text-gray-900 sm:col-span-2">
                <%= dayjs(group.drawDeadline).format('YYYY-MM-DD') %>
              </dd>
            </div>
            <% } %> <% if (group.rules) { %>
            <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500">Reglas</dt>
              <dd
                class="text-sm text-gray-900 sm:col-span-2 whitespace-pre-line break-words"
              >
                <%= group.rules %>
              </dd>
            </div>
            <% } %>
            <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
              <dt class="text-sm font-medium text-gray-500">Invitación</dt>
              <dd class="text-sm text-gray-900 sm:col-span-2">
                <div class="bg-gray-100 rounded px-3 py-2 break-all text-xs sm:text-sm">
                  <%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>
                </div>
                <a
                  class="inline-flex items-center gap-1 text-blue-600 hover:underline mt-2 text-sm"
                  href="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"
                  ><%- renderIcon("open_in_new", "text-sm") %> Abrir enlace</a
                >
              </dd>
            </div>
          </dl>
        </section>

        <section class="bg-white shadow rounded-lg p-4 sm:p-6">
          <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <%- renderIcon("people", "text-xl") %> Participantes (<%= participants.length %>)
          </h3>
          <ul class="space-y-2 sm:space-y-3 text-gray-800">
            <% participants.forEach(p => { %>
            <li class="flex items-center gap-2 sm:gap-3">
              <div class="flex-shrink-0">
                <% if (p.user.profilePhoto) { %>
                <img
                  src="<%= p.user.profilePhoto %>"
                  alt="<%= p.user.name %>"
                  class="h-8 w-8 sm:h-10 sm:w-10 rounded-full object-cover border border-gray-300"
                />
                <% } else { %>
                <div
                  class="h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-gradient-to-br from-gray-400 to-gray-600 flex items-center justify-center text-white text-xs sm:text-sm font-semibold"
                >
                  <%= p.user.name.charAt(0).toUpperCase() %>
                </div>
                <% } %>
              </div>
              <span class="font-medium text-sm sm:text-base truncate"><%= p.user.name %></span>
            </li>
            <% }) %>
          </ul>
        </section>
      </div>

      <section class="bg-white shadow rounded-lg p-4 sm:p-6 mt-6">
        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <%- renderIcon("card_giftcard", "text-xl") %> Tu resultado
        </h3>
        <% if (group.drawnAt && receiver) { %>
        <div
          class="flex items-center gap-3 sm:gap-4 p-4 bg-red-50 rounded-lg border border-red-200"
        >
          <div class="flex-shrink-0">
            <% if (receiver.profilePhoto) { %>
            <img
              src="<%= receiver.profilePhoto %>"
              alt="<%= receiver.name %>"
              class="h-12 w-12 sm:h-16 sm:w-16 rounded-full object-cover border-2 border-red-300"
            />
            <% } else { %>
            <div
              class="h-12 w-12 sm:h-16 sm:w-16 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white text-lg sm:text-xl font-semibold"
            >
              <%= receiver.name.charAt(0).toUpperCase() %>
            </div>
            <% } %>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs sm:text-sm text-gray-600 mb-1">Tu amigo invisible es:</p>
            <p class="text-xl sm:text-2xl font-bold text-red-600 break-words"><%= receiver.name %></p>
          </div>
        </div>
        <% } else if (!group.drawnAt) { %>
        <p class="text-gray-600 text-sm sm:text-base">Aún no se ha realizado el sorteo.</p>
        <% } else { %>
        <p class="text-gray-600 text-sm sm:text-base">No se encontró asignación.</p>
        <% } %>
      </section>
    </main>
    <%- include('../partials/footer') %>
  </body>
</html>
