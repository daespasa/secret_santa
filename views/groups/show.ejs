<%- include('../partials/layout-full-start', { title: group.name, description:
`Detalles del grupo ${group.name}: participantes, invitaci√≥n y estado del sorteo
de amigo invisible.`, includeHeader: true }) %>
<main
  class="flex-1 max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-10 w-full">
  <%- include('../partials/flash') %>

  <header class="bg-white shadow rounded-lg p-4 sm:p-6 mb-6">
    <div class="flex flex-col gap-4">
      <!-- Header Top: Icon, Title, Status -->
      <div class="flex items-start gap-3 flex-1">
        <span
          class="flex-shrink-0 text-3xl sm:text-4xl"
          data-group-color="<%= group.color || '#DC2626' %>"
          ><%- renderGroupIcon(group.icon, "text-3xl sm:text-4xl") %></span
        >
        <div class="min-w-0 flex-1">
          <h2 class="text-xl sm:text-2xl font-bold text-gray-900 break-words">
            <%= group.name %>
          </h2>
          <% if (group.description) { %>
          <p class="text-gray-600 mt-1 text-sm sm:text-base break-words">
            <%= group.description %>
          </p>
          <% } %>
          <p class="mt-2 text-sm">
            Estado: <% if (group.drawnAt) { %>
            <span
              class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-green-100 text-green-800"
              ><%- renderIcon("check_circle", "text-xs mr-1") %>Sorteado</span
            >
            <% } else { %>
            <span
              class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-orange-100 text-orange-800"
              ><%- renderIcon("schedule", "text-xs mr-1") %>Pendiente</span
            >
            <% } %>
          </p>
        </div>
      </div>

      <!-- Action Buttons Grid -->
      <div
        class="grid grid-cols-2 sm:grid-cols-auto gap-2 sm:gap-2 auto-cols-max sm:flex sm:flex-wrap">
        <% if (!isGuest && !group.drawnAt && group.adminUserId ===
        currentUser.id) { %>
        <form
          method="post"
          action="/groups/<%= group.id %>/draw"
          class="w-full sm:w-auto">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button
            type="submit"
            class="w-full inline-flex items-center justify-center gap-1 sm:gap-2 px-3 sm:px-4 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 transition text-xs sm:text-sm font-medium">
            <%- renderIcon("dice", "text-sm") %>
            <span class="hidden sm:inline">Iniciar sorteo</span
            ><span class="sm:hidden">Sorteo</span>
          </button>
        </form>
        <% } %> <% if (!isGuest && group.adminUserId === currentUser.id) { %>
        <a
          href="/groups/<%= group.id %>/edit"
          class="inline-flex items-center justify-center gap-1 sm:gap-2 px-3 sm:px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 transition text-xs sm:text-sm font-medium">
          <%- renderIcon("edit", "text-sm") %>
          <span class="hidden sm:inline">Editar</span
          ><span class="sm:hidden">Editar</span>
        </a>
        <% } %> <% if (!isGuest && group.adminUserId === currentUser.id) { %>
        <button
          type="button"
          class="inline-flex items-center justify-center gap-1 sm:gap-2 px-3 sm:px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 transition text-xs sm:text-sm font-medium toggle-delete-modal">
          <%- renderIcon("delete", "text-sm") %>
          <span class="hidden sm:inline">Eliminar</span
          ><span class="sm:hidden">Eliminar</span>
        </button>
        <% } else if (!isGuest) { %>
        <form
          method="post"
          action="/groups/<%= group.id %>/leave"
          class="w-full sm:w-auto">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
          <button
            type="submit"
            class="w-full inline-flex items-center justify-center gap-1 sm:gap-2 px-3 sm:px-4 py-2 rounded-md bg-orange-600 text-white hover:bg-orange-700 transition text-xs sm:text-sm font-medium"
            onclick="return confirm('¬øEst√°s seguro de que quieres dejar este grupo?')">
            <%- renderIcon("logout", "text-sm") %>
            <span class="hidden sm:inline">Dejar grupo</span
            ><span class="sm:hidden">Salir</span>
          </button>
        </form>
        <% } %>
      </div>
    </div>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="bg-white shadow rounded-lg p-4 sm:p-6 lg:col-span-2">
      <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <%- renderIcon("info", "text-xl") %> Detalles
      </h3>
      <dl class="divide-y divide-gray-200 text-sm sm:text-base">
        <% if (group.priceMax) { %>
        <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
          <dt class="text-xs sm:text-sm font-medium text-gray-500">
            Precio m√°ximo
          </dt>
          <dd
            class="text-sm sm:text-base text-gray-900 sm:col-span-2 font-medium">
            $<%= group.priceMax %>
          </dd>
        </div>
        <% } %> <% if (group.eventDate) { %>
        <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
          <dt class="text-xs sm:text-sm font-medium text-gray-500">Evento</dt>
          <dd
            class="text-sm sm:text-base text-gray-900 sm:col-span-2 font-medium">
            <%= dayjs(group.eventDate).format('DD MMM YYYY') %>
          </dd>
        </div>
        <% } %> <% if (group.drawDeadline) { %>
        <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
          <dt class="text-xs sm:text-sm font-medium text-gray-500">
            L√≠mite inscripci√≥n
          </dt>
          <dd
            class="text-sm sm:text-base text-gray-900 sm:col-span-2 font-medium">
            <%= dayjs(group.drawDeadline).format('DD MMM YYYY') %>
          </dd>
        </div>
        <% } %> <% if (group.rules) { %>
        <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-1 sm:gap-4">
          <dt class="text-xs sm:text-sm font-medium text-gray-500">Reglas</dt>
          <dd
            class="text-xs sm:text-sm text-gray-700 sm:col-span-2 whitespace-pre-wrap break-words mt-2 sm:mt-0 max-h-32 overflow-y-auto">
            <%= group.rules %>
          </dd>
        </div>
        <% } %>
        <div class="py-3 flex flex-col sm:grid sm:grid-cols-3 gap-3 sm:gap-4">
          <dt class="text-xs sm:text-sm font-medium text-gray-500">
            Invitaci√≥n
          </dt>
          <dd class="text-xs sm:text-sm text-gray-900 sm:col-span-2">
            <div
              class="bg-gray-100 rounded px-2 sm:px-3 py-2 break-all text-xs mb-3 font-mono border border-gray-300 overflow-x-auto">
              <%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>
            </div>
            <div class="grid grid-cols-3 gap-2 sm:flex sm:flex-row sm:gap-2">
              <a
                class="inline-flex flex-col sm:flex-row items-center justify-center gap-1 text-blue-600 hover:bg-blue-50 text-xs sm:text-sm px-2 sm:px-3 py-2 sm:py-2 rounded border border-blue-200 hover:underline transition font-medium"
                href="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"
                title="Abrir enlace de invitaci√≥n"
                ><%- renderIcon("open_in_new", "text-base") %>
                <span class="text-xs">Abrir</span></a
              >
              <button
                type="button"
                class="copy-group-link inline-flex flex-col sm:flex-row items-center justify-center gap-1 text-gray-700 hover:bg-gray-200 text-xs sm:text-sm px-2 sm:px-3 py-2 sm:py-2 rounded border border-gray-300 transition font-medium"
                data-invite-link="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"
                title="Copiar enlace de invitaci√≥n">
                <%- renderIcon("link", "text-base") %>
                <span class="text-xs">Copiar</span>
              </button>
              <div class="share-dropdown-container">
                <button
                  type="button"
                  class="share-group-btn w-full inline-flex flex-col sm:flex-row items-center justify-center gap-1 text-gray-700 hover:bg-gray-200 text-xs sm:text-sm px-2 sm:px-3 py-2 sm:py-2 rounded border border-gray-300 transition font-medium"
                  data-group-name="<%= group.name %>"
                  data-invite-link="<%= `${config?.baseUrl || ''}/join/${group.joinToken}` %>"
                  title="Compartir grupo">
                  <%- renderIcon("share", "text-base") %>
                  <span class="text-xs">Compartir</span>
                </button>
              </div>
            </div>
          </dd>
        </div>
      </dl>
    </section>

    <section class="bg-white shadow rounded-lg p-4 sm:p-6">
      <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <%- renderIcon("people", "text-xl") %> Participantes (<%=
        participants.length %>)
      </h3>
      <ul class="space-y-2 sm:space-y-3 text-gray-800">
        <% participants.forEach(p => { %> <% const displayName = p.isGuest ?
        p.guestName : p.user.name; %> <% const hasPhoto = !p.isGuest &&
        p.user.profilePhoto; %>
        <li
          class="flex items-center gap-2 sm:gap-3 p-2 sm:p-0 rounded hover:bg-gray-50 transition">
          <div class="flex-shrink-0">
            <% if (hasPhoto) { %>
            <img
              src="<%= p.user.profilePhoto %>"
              alt="<%= displayName %>"
              class="h-8 w-8 sm:h-10 sm:w-10 rounded-full object-cover border border-gray-300" />
            <% } else { %>
            <div
              class="h-8 w-8 sm:h-10 sm:w-10 rounded-full bg-gradient-to-br <%= p.isGuest ? 'from-blue-400 to-blue-600' : 'from-gray-400 to-gray-600' %> flex items-center justify-center text-white text-xs sm:text-sm font-semibold flex-shrink-0">
              <%= displayName.charAt(0).toUpperCase() %>
            </div>
            <% } %>
          </div>
          <span class="font-medium text-xs sm:text-base truncate">
            <%= displayName %> <% if (p.isGuest) { %>
            <span class="text-xs text-gray-500 ml-1">(invitado)</span>
            <% } %>
          </span>
        </li>
        <% }) %>
      </ul>
    </section>
  </div>

  <section class="bg-white shadow rounded-lg p-4 sm:p-6 mt-6">
    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
      <%- renderIcon("card_giftcard", "text-xl") %> Tu resultado
    </h3>
    <% if (group.drawnAt && receiver) { %>
    <div
      class="flex flex-col sm:flex-row items-center sm:items-start gap-4 sm:gap-6 p-4 sm:p-6 bg-gradient-to-br from-red-50 to-pink-50 rounded-lg border-2 border-red-200">
      <div class="flex-shrink-0">
        <% if (receiver.profilePhoto) { %>
        <img
          src="<%= receiver.profilePhoto %>"
          alt="<%= receiver.name %>"
          class="h-16 w-16 sm:h-20 sm:w-20 rounded-full object-cover border-2 sm:border-3 border-red-300 shadow-md" />
        <% } else { %>
        <div
          class="h-16 w-16 sm:h-20 sm:w-20 rounded-full bg-gradient-to-br from-red-400 to-red-600 flex items-center justify-center text-white text-2xl sm:text-3xl font-semibold shadow-md">
          <%= receiver.name.charAt(0).toUpperCase() %>
        </div>
        <% } %>
      </div>
      <div class="text-center sm:text-left flex-1">
        <p class="text-xs sm:text-sm text-gray-600 font-medium mb-2">
          Tu amigo invisible es:
        </p>
        <p class="text-2xl sm:text-3xl font-bold text-red-600 break-words">
          <%= receiver.name %>
        </p>
        <p class="text-xs sm:text-sm text-gray-500 mt-2">
          ¬°Que comience la aventura! üéÅ
        </p>
      </div>
    </div>
    <% } else if (!group.drawnAt) { %>
    <div class="p-4 sm:p-6 bg-orange-50 rounded-lg border border-orange-200">
      <p class="text-gray-700 text-sm sm:text-base flex items-center gap-2">
        <%- renderIcon("schedule", "text-xl text-orange-600") %> A√∫n no se ha
        realizado el sorteo.
      </p>
    </div>
    <% } else { %>
    <div class="p-4 sm:p-6 bg-blue-50 rounded-lg border border-blue-200">
      <p class="text-gray-700 text-sm sm:text-base flex items-center gap-2">
        <%- renderIcon("info", "text-xl text-blue-600") %> No se encontr√≥
        asignaci√≥n.
      </p>
    </div>
    <% } %>
  </section>
</main>

<!-- Delete Group Modal -->
<div
  id="deleteModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4 sm:p-6">
  <div class="bg-white rounded-lg max-w-sm w-full p-5 sm:p-6 shadow-xl">
    <h3
      class="text-base sm:text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
      <%- renderIcon("warning", "text-2xl text-red-600") %> Eliminar grupo
    </h3>
    <p class="text-gray-600 text-sm sm:text-base mb-6">
      ¬øQu√© deseas hacer con este grupo?
    </p>

    <div class="space-y-3 mb-6 text-xs sm:text-sm">
      <div class="p-3 bg-yellow-50 rounded border border-yellow-200">
        <p class="text-gray-700">
          <strong class="text-yellow-700">Archivar:</strong> El grupo se
          ocultar√° pero los datos se conservar√°n.
        </p>
      </div>
      <div class="p-3 bg-red-50 rounded border border-red-200">
        <p class="text-gray-700">
          <strong class="text-red-700">Eliminar:</strong> El grupo y todos sus
          datos se eliminar√°n permanentemente.
        </p>
      </div>
    </div>

    <form
      method="post"
      action="/groups/<%= group.id %>/delete"
      id="deleteForm"
      class="flex flex-col gap-2 sm:gap-3">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
      <input type="hidden" name="action" id="actionInput" value="" />

      <button
        type="button"
        class="px-3 sm:px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-50 transition cancel-delete-modal text-xs sm:text-sm font-medium">
        Cancelar
      </button>
      <button
        type="button"
        class="px-3 sm:px-4 py-2 rounded-md bg-yellow-600 text-white hover:bg-yellow-700 transition text-xs sm:text-sm font-medium archive-btn flex items-center justify-center gap-2">
        <%- renderIcon("archive", "text-base") %> Archivar
      </button>
      <button
        type="button"
        class="px-3 sm:px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 transition text-xs sm:text-sm font-medium delete-btn flex items-center justify-center gap-2">
        <%- renderIcon("delete_forever", "text-base") %> Eliminar
      </button>
    </form>
  </div>
</div>

<script>
  // Apply dynamic group color
  document.querySelectorAll("[data-group-color]").forEach((el) => {
    const color = el.getAttribute("data-group-color");
    if (color) {
      el.style.color = color;
    }
  });

  // Delete modal
  const deleteModal = document.getElementById("deleteModal");
  const toggleDeleteBtn = document.querySelector(".toggle-delete-modal");
  const cancelDeleteBtn = document.querySelector(".cancel-delete-modal");

  if (toggleDeleteBtn) {
    toggleDeleteBtn.addEventListener("click", () => {
      deleteModal.classList.remove("hidden");
      deleteModal.classList.add("flex");
    });
  }

  if (cancelDeleteBtn) {
    cancelDeleteBtn.addEventListener("click", () => {
      deleteModal.classList.add("hidden");
      deleteModal.classList.remove("flex");
    });
  }

  // Close modal when clicking outside
  deleteModal.addEventListener("click", (e) => {
    if (e.target === deleteModal) {
      deleteModal.classList.add("hidden");
      deleteModal.classList.remove("flex");
    }
  });

  // Archive button handler
  const archiveBtn = document.querySelector(".archive-btn");
  if (archiveBtn) {
    archiveBtn.addEventListener("click", () => {
      document.getElementById("actionInput").value = "archive";
      document.getElementById("deleteForm").submit();
    });
  }

  // Delete button handler
  const deleteBtn = document.querySelector(".delete-btn");
  if (deleteBtn) {
    deleteBtn.addEventListener("click", () => {
      if (
        confirm("‚ö†Ô∏è Esta acci√≥n es irreversible. ¬øEst√°s completamente seguro?")
      ) {
        document.getElementById("actionInput").value = "delete";
        document.getElementById("deleteForm").submit();
      }
    });
  }

  // Share dropdown functionality with dynamic positioning
  const shareDropdownContainers = document.querySelectorAll(
    ".share-dropdown-container"
  );

  // Create global dropdown menu if it doesn't exist
  let globalShareMenu = document.getElementById("global-share-dropdown-menu");
  if (!globalShareMenu) {
    globalShareMenu = document.createElement("div");
    globalShareMenu.id = "global-share-dropdown-menu";
    globalShareMenu.className =
      "fixed bg-white rounded-md shadow-lg opacity-0 invisible transition-opacity duration-200 z-50 w-40";
    globalShareMenu.innerHTML = `
          <a href="#" class="share-group-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-md" data-platform="whatsapp"><%- renderIcon("whatsapp", "text-base mr-1.5") %>WhatsApp</a>
          <a href="#" class="share-group-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-platform="telegram"><%- renderIcon("telegram", "text-base mr-1.5") %>Telegram</a>
          <a href="#" class="share-group-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-platform="twitter"><%- renderIcon("twitter", "text-base mr-1.5") %>Twitter</a>
          <a href="#" class="share-group-link block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-md" data-platform="email"><%- renderIcon("email_icon", "text-base mr-1.5") %>Email</a>
        `;
    document.body.appendChild(globalShareMenu);
  }

  shareDropdownContainers.forEach((container) => {
    const btn = container.querySelector(".share-group-btn");

    if (btn) {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();

        // Get button position
        const rect = btn.getBoundingClientRect();

        // Position the global menu
        globalShareMenu.style.top = rect.bottom + 8 + "px";
        globalShareMenu.style.left = rect.left + "px";

        // Store group info in menu links
        const groupName = btn.getAttribute("data-group-name");
        const inviteLink = btn.getAttribute("data-invite-link");
        globalShareMenu
          .querySelectorAll(".share-group-link")
          .forEach((link) => {
            link.setAttribute("data-group-name", groupName);
            link.setAttribute("data-invite-link", inviteLink);
          });

        // Toggle menu visibility
        const isHidden = globalShareMenu.classList.contains("opacity-0");
        if (isHidden) {
          globalShareMenu.classList.remove("opacity-0", "invisible");
          globalShareMenu.classList.add("opacity-100", "visible");
        } else {
          globalShareMenu.classList.add("opacity-0", "invisible");
          globalShareMenu.classList.remove("opacity-100", "visible");
        }
      });
    }
  });

  // Close menu when clicking outside
  document.addEventListener("click", (e) => {
    if (
      !e.target.closest(".share-dropdown-container") &&
      e.target !== globalShareMenu
    ) {
      globalShareMenu.classList.add("opacity-0", "invisible");
      globalShareMenu.classList.remove("opacity-100", "visible");
    }
  });

  // Share links handler
  globalShareMenu.querySelectorAll(".share-group-link").forEach((link) => {
    link.addEventListener("click", (e) => {
      e.preventDefault();
      const platform = link.getAttribute("data-platform");
      const groupName = link.getAttribute("data-group-name");
      const inviteLink = link.getAttribute("data-invite-link");
      const message = `¬°√önete a nuestro grupo "${groupName}" en Amigo Invisible! ${inviteLink}`;

      let shareUrl;
      switch (platform) {
        case "whatsapp":
          shareUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
          break;
        case "telegram":
          shareUrl = `https://t.me/share/url?url=${encodeURIComponent(
            inviteLink
          )}&text=${encodeURIComponent(
            `¬°√önete a nuestro grupo "${groupName}" en Amigo Invisible!`
          )}`;
          break;
        case "twitter":
          shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(
            `¬°√önete a "${groupName}" en Amigo Invisible! ${inviteLink}`
          )}`;
          break;
        case "email":
          shareUrl = `mailto:?subject=${encodeURIComponent(
            `√önete a ${groupName} en Amigo Invisible`
          )}&body=${encodeURIComponent(message)}`;
          break;
      }

      if (shareUrl) {
        window.open(shareUrl, "_blank");
      }

      // Close menu after sharing
      globalShareMenu.classList.add("opacity-0", "invisible");
      globalShareMenu.classList.remove("opacity-100", "visible");
    });
  });

  // Copy group link functionality
  const copyGroupLinkBtns = document.querySelectorAll(".copy-group-link");
  copyGroupLinkBtns.forEach((btn) => {
    btn.addEventListener("click", async () => {
      const inviteLink = btn.getAttribute("data-invite-link");

      try {
        await navigator.clipboard.writeText(inviteLink);

        // Show feedback
        const originalText = btn.innerHTML;
        btn.innerHTML =
          '<%- renderIcon("check_circle", "text-sm") %> <span>¬°Copiado!</span>';
        btn.classList.add("bg-green-50", "text-green-700");

        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.classList.remove("bg-green-50", "text-green-700");
        }, 2000);
      } catch (err) {
        console.error("Error copying to clipboard:", err);
        alert("Error al copiar el enlace");
      }
    });
  });
</script>
<%- include('../partials/layout-full-end') %>
